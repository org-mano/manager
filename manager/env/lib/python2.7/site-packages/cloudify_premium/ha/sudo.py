import os
import pwd
import stat
import json
import shutil
import subprocess
import pkg_resources


SUDO_SCRIPT_PATH = '/opt/cloudify/sudo_trampoline.py'
SUDO_CONFIG_FILE = '/opt/cloudify/sudo.json'


def run(command):
        subprocess.check_output(['sudo', SUDO_SCRIPT_PATH] + command)


def deploy_script():
    from cloudify_premium.ha import services

    root = pwd.getpwnam('root')
    trampoline_filename = pkg_resources.resource_filename(
        __name__, 'resources/sudo_trampoline.py')
    sudo_resources_dir = pkg_resources.resource_filename(
        __name__, 'resources/sudo')
    shutil.copytree(sudo_resources_dir, '/opt/cloudify/sudo')
    os.chown('/opt/cloudify/sudo', root.pw_uid, root.pw_gid)
    shutil.copy(trampoline_filename, SUDO_SCRIPT_PATH)
    os.chmod(SUDO_SCRIPT_PATH, stat.S_IRUSR | stat.S_IXUSR)
    os.chown(SUDO_SCRIPT_PATH, root.pw_uid, root.pw_gid)
    with open(SUDO_CONFIG_FILE, 'w') as f:
        json.dump({
            'manager_services': [
                s._service_name for s in services.MANAGER_SERVICES],
            'master_only_services': [
                s._service_name for s in services.MASTER_ONLY_SERVICES],
            'resources': '/opt/cloudify/sudo'
        }, f)
    os.chmod(SUDO_CONFIG_FILE, stat.S_IRUSR)
    with open('/etc/sudoers.d/cfycluster_sudo_trampoline', 'w') as f:
        f.write('Defaults:%cluster !requiretty\n')
        f.write('%cluster    ALL=(root) NOPASSWD:{script}\n'
                .format(script=SUDO_SCRIPT_PATH))
